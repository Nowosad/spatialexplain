<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatial SHAP • spatialexplain</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial SHAP">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spatialexplain</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/An-introduction-to-spatial-explanations.html">An introduction to spatial explanations</a></li>
    <li><a class="dropdown-item" href="../articles/Spatial-break-down.html">Spatial break-down</a></li>
    <li><a class="dropdown-item" href="../articles/Spatial-LIME.html">Spatial LIME</a></li>
    <li><a class="dropdown-item" href="../articles/Spatial-oscillations.html">Spatial oscillations</a></li>
    <li><a class="dropdown-item" href="../articles/Spatial-SHAP.html">Spatial SHAP</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Nowosad/spatialexplain/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spatial SHAP</h1>
                        <h4 data-toc-skip class="author">Jakub
Nowosad</h4>
            
            <h4 data-toc-skip class="date">2025-01-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Nowosad/spatialexplain/blob/main/vignettes/articles/Spatial-SHAP.Rmd" class="external-link"><code>vignettes/articles/Spatial-SHAP.Rmd</code></a></small>
      <div class="d-none name"><code>Spatial-SHAP.Rmd</code></div>
    </div>

    
    
<p>The <strong>spatialexplain</strong> package provides model agnostic
tools for exploring and explaining spatial machine learning models. This
vignette shows a simple example of how to use it to explain a regression
model with the SHAP method.</p>
<p>Lets start by attaching the necessary packages, reading the
predictors raster, and loading the pre-trained regression model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># attaching the necessary packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/spatialexplain" class="external-link">spatialexplain</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># reading the predictors raster</span></span>
<span><span class="va">predictors</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"/vsicurl/https://github.com/Nowosad/IIIRqueR_workshop_materials/raw/refs/heads/main/data/predictors.tif"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">predictors</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spatial-SHAP_files/figure-html/setup-1.png" width="700"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># loading the pre-trained regression model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"regr_exp"</span>, package <span class="op">=</span> <span class="st">"spatialexplain"</span><span class="op">)</span></span>
<span><span class="va">regr_exp</span></span>
<span><span class="co">#&gt; Model label:  rpart </span></span>
<span><span class="co">#&gt; Model class:  rpart </span></span>
<span><span class="co">#&gt; Data head  :</span></span>
<span><span class="co">#&gt;    popdens    coast      dem      ndvi  lst_day lst_night</span></span>
<span><span class="co">#&gt; 1 0.000000 1.126301 85.90540 0.3656146 24.37792  12.64256</span></span>
<span><span class="co">#&gt; 2 1.211701 6.743273 75.00126 0.3990190 28.13341  10.70668</span></span></code></pre></div>
<p>The SHAP method is a model-agnostic method that explains the model’s
predictions by attributing the prediction to each feature. However, as
compared to the Break Down method, the SHAP method uses the idea of
averaging the value of a variable’s attribution over all or many
possible orderings. This has two main implications: the SHAP method is
computationally more expensive, but its results are less sensitive to
the order of the variables. This method provides additive feature
attribution – thus, it works best for additive models (e.g., linear
regression), and if the model is not additive, the SHAP values may not
be meaningful.</p>
<p>We can use the <code><a href="../reference/map_shap.html">map_shap()</a></code> function to explain the
regression model using the SHAP method.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regr_psp_shap</span> <span class="op">=</span> <span class="fu"><a href="../reference/map_shap.html">map_shap</a></span><span class="op">(</span><span class="va">regr_exp</span>, <span class="va">predictors</span>, maxcell <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">regr_psp_shap</span><span class="op">)</span></span></code></pre></div>
<p><img src="Spatial-SHAP_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>The resulting maps show that the <code>popdens</code>,
<code>coast</code>, and <code>ndvi</code> variables had no effect on the
model’s predictions. The <code>dem</code> variable mostly influenced the
results in the mountainous areas, while <code>lst_day</code> and
<code>lst_night</code> had different effects for the south and north
parts of Spain.</p>
<p>For more explanation of the SHAP method, read the <a href="https://ema.drwhy.ai/shapley.html" class="external-link">“Shapley Additive Explanations
(SHAP) for Average Attributions”</a> chapter from the <a href="https://ema.drwhy.ai/" class="external-link">Explanatory Model Analysis</a> book.</p>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jakub Nowosad.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
